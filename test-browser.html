<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-result.passed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.failed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-result.running {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 20px;
            background: #4a7c2a;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #6b9f4a;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h1>
    
    <div class="test-container">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏</h2>
        <button onclick="runAllTests()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
        <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    </div>
    
    <div id="testResults" class="test-container">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
        <div id="results"></div>
        <div id="summary" class="summary" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8081/api/v1';
        
        const TEST_USERS = {
            manager: { login: '–ü–µ—Ç—Ä–æ–≤–∞ –í.–í.', password: 'petrow' },
            technician: { login: '–ê–Ω–∞–Ω—å–µ–≤ –ú.–û.', password: '123456' },
            admin: { login: '–ë–æ–≥–¥–∞–Ω–æ–≤ –ï.–ò.', password: 'qerTY123' }
        };
        
        let authTokens = {};
        let testResults = [];
        
        async function fetchAPI(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(options.token ? { 'Authorization': `Bearer ${options.token}` } : {}),
                        ...(options.headers || {})
                    }
                });
                
                const text = await response.text();
                let data = {};
                try {
                    data = text ? JSON.parse(text) : {};
                } catch (e) {
                    data = { error: 'Invalid JSON', text };
                }
                
                return { response, data };
            } catch (error) {
                return { response: null, data: { error: error.message } };
            }
        }
        
        function addTestResult(name, passed, message = '') {
            testResults.push({ name, passed, message, time: new Date() });
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'passed' : 'failed'}`;
            resultDiv.innerHTML = `
                <span>${passed ? '‚úÖ' : '‚ùå'}</span>
                <span><strong>${name}</strong>${message ? ': ' + message : ''}</span>
            `;
            resultsDiv.appendChild(resultDiv);
        }
        
        async function testHealthCheck() {
            addTestResult('Health Check', true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            try {
                const response = await fetch('http://localhost:8081/health');
                const passed = response.ok || response.status === 200;
                addTestResult('Health Check', passed, passed ? '–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç' : `–°—Ç–∞—Ç—É—Å: ${response.status}`);
                return passed;
            } catch (error) {
                addTestResult('Health Check', false, error.message);
                return false;
            }
        }
        
        async function testLogin(userType) {
            const user = TEST_USERS[userType];
            addTestResult(`–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (${userType})`, true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            
            try {
                const { response, data } = await fetchAPI(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify(user)
                });
                
                if (response?.ok && data.accessToken) {
                    authTokens[userType] = data.accessToken;
                    addTestResult(`–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (${userType})`, true, `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.name}`);
                    return true;
                } else {
                    addTestResult(`–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (${userType})`, false, data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                    return false;
                }
            } catch (error) {
                addTestResult(`–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (${userType})`, false, error.message);
                return false;
            }
        }
        
        async function testLoadTickets() {
            if (!authTokens.manager) {
                addTestResult('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫', false, '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return false;
            }
            
            addTestResult('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫', true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            try {
                const { response, data } = await fetchAPI(`${API_BASE}/tickets`, {
                    token: authTokens.manager
                });
                
                const passed = response?.ok === true && Array.isArray(data.items);
                addTestResult('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫', passed, 
                    passed ? `–ù–∞–π–¥–µ–Ω–æ –∑–∞—è–≤–æ–∫: ${data.items.length}` : (data.error || '–û—à–∏–±–∫–∞'));
                return passed;
            } catch (error) {
                addTestResult('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫', false, error.message);
                return false;
            }
        }
        
        async function testLoadUsers() {
            if (!authTokens.manager) {
                addTestResult('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', false, '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return false;
            }
            
            addTestResult('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            try {
                const { response, data } = await fetchAPI(`${API_BASE}/users`, {
                    token: authTokens.manager
                });
                
                const passed = response?.ok === true && Array.isArray(data.items);
                addTestResult('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', passed,
                    passed ? `–ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.items.length}` : (data.error || '–û—à–∏–±–∫–∞'));
                return passed;
            } catch (error) {
                addTestResult('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', false, error.message);
                return false;
            }
        }
        
        async function testCreateTicket() {
            if (!authTokens.manager) {
                addTestResult('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏', false, '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return null;
            }
            
            addTestResult('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏', true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            try {
                const ticketData = {
                    title: `–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞ ${Date.now()}`,
                    description: '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏',
                    priority: 'MEDIUM'
                };
                
                const { response, data } = await fetchAPI(`${API_BASE}/tickets`, {
                    method: 'POST',
                    token: authTokens.manager,
                    body: JSON.stringify(ticketData)
                });
                
                if (response?.ok && data.id) {
                    addTestResult('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏', true, `ID: ${data.id}`);
                    return data.id;
                } else {
                    addTestResult('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏', false, data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
                    return null;
                }
            } catch (error) {
                addTestResult('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏', false, error.message);
                return null;
            }
        }
        
        async function testAssignTicket(ticketId) {
            if (!ticketId) {
                addTestResult('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∞', false, '–ù–µ—Ç ID –∑–∞—è–≤–∫–∏');
                return false;
            }
            
            if (!authTokens.manager) {
                addTestResult('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∞', false, '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
                return false;
            }
            
            addTestResult('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∞', true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω–∏–∫–æ–≤
                const { response: usersResp, data: usersData } = await fetchAPI(`${API_BASE}/users`, {
                    token: authTokens.manager
                });
                
                if (!usersResp?.ok || !Array.isArray(usersData.items)) {
                    addTestResult('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∞', false, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫–æ–≤');
                    return false;
                }
                
                const technician = usersData.items.find(u => u.role === 'TECHNICIAN');
                if (!technician) {
                    addTestResult('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∞', false, '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫–æ–≤');
                    return false;
                }
                
                const { response, data } = await fetchAPI(`${API_BASE}/tickets/${ticketId}/assign`, {
                    method: 'PUT',
                    token: authTokens.manager,
                    body: JSON.stringify({ technicianId: technician.id })
                });
                
                const passed = response?.ok === true;
                addTestResult('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∞', passed,
                    passed ? `–ù–∞–∑–Ω–∞—á–µ–Ω: ${technician.name}` : (data.error || '–û—à–∏–±–∫–∞'));
                return passed;
            } catch (error) {
                addTestResult('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∞', false, error.message);
                return false;
            }
        }
        
        async function testAcceptTicket(ticketId) {
            if (!ticketId) {
                addTestResult('–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏', false, '–ù–µ—Ç ID –∑–∞—è–≤–∫–∏');
                return false;
            }
            
            // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∫–∞–∫ —Ç–µ—Ö–Ω–∏–∫
            if (!authTokens.technician) {
                const loggedIn = await testLogin('technician');
                if (!loggedIn) return false;
            }
            
            addTestResult('–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏', true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            try {
                const { response, data } = await fetchAPI(`${API_BASE}/tickets/${ticketId}/accept`, {
                    method: 'PUT',
                    token: authTokens.technician,
                    body: JSON.stringify({ estimatedCompletionTime: Math.floor(Date.now() / 1000) + 3600 })
                });
                
                const passed = response?.ok === true;
                addTestResult('–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏', passed,
                    passed ? '–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞' : (data.error || '–û—à–∏–±–∫–∞'));
                return passed;
            } catch (error) {
                addTestResult('–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–∫–∏', false, error.message);
                return false;
            }
        }
        
        async function testCompleteTicket(ticketId) {
            if (!ticketId) {
                addTestResult('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏', false, '–ù–µ—Ç ID –∑–∞—è–≤–∫–∏');
                return false;
            }
            
            if (!authTokens.technician) {
                addTestResult('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏', false, '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ —Ç–µ—Ö–Ω–∏–∫–∞');
                return false;
            }
            
            addTestResult('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏', true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            try {
                const { response, data } = await fetchAPI(`${API_BASE}/tickets/${ticketId}/complete`, {
                    method: 'PUT',
                    token: authTokens.technician,
                    body: JSON.stringify({ comments: '–¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏' })
                });
                
                const passed = response?.ok === true;
                addTestResult('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏', passed,
                    passed ? '–ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞' : (data.error || '–û—à–∏–±–∫–∞'));
                return passed;
            } catch (error) {
                addTestResult('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏', false, error.message);
                return false;
            }
        }
        
        async function testPDFExport() {
            if (!authTokens.manager) {
                addTestResult('–≠–∫—Å–ø–æ—Ä—Ç PDF', false, '–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return false;
            }
            
            addTestResult('–≠–∫—Å–ø–æ—Ä—Ç PDF', true, '–ü—Ä–æ–≤–µ—Ä–∫–∞...');
            try {
                const response = await fetch(`${API_BASE}/tickets/export/pdf?period=day`, {
                    headers: { 'Authorization': `Bearer ${authTokens.manager}` }
                });
                
                const passed = response.ok && response.headers.get('content-type')?.includes('pdf');
                addTestResult('–≠–∫—Å–ø–æ—Ä—Ç PDF', passed, passed ? 'PDF —Å–æ–∑–¥–∞–Ω' : `–°—Ç–∞—Ç—É—Å: ${response.status}`);
                return passed;
            } catch (error) {
                addTestResult('–≠–∫—Å–ø–æ—Ä—Ç PDF', false, error.message);
                return false;
            }
        }
        
        async function testOfflineSupport() {
            const hasIndexedDB = typeof indexedDB !== 'undefined';
            const hasServiceWorker = typeof navigator !== 'undefined' && 'serviceWorker' in navigator;
            const hasNotifications = typeof Notification !== 'undefined';
            
            addTestResult('–ü–æ–¥–¥–µ—Ä–∂–∫–∞ IndexedDB', hasIndexedDB, hasIndexedDB ? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            addTestResult('–ü–æ–¥–¥–µ—Ä–∂–∫–∞ Service Worker', hasServiceWorker, hasServiceWorker ? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            addTestResult('–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', hasNotifications, hasNotifications ? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            
            return hasIndexedDB && hasServiceWorker && hasNotifications;
        }
        
        async function runAllTests() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testResults = [];
            
            console.log('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...\n');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
            await testHealthCheck();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            await testLogin('manager');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã
            await testLoadUsers();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testLoadTickets();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
            const ticketId = await testCreateTicket();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // –¢–µ—Å—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫–∞
            if (ticketId) {
                await testAssignTicket(ticketId);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // –¢–µ—Å—Ç –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏ (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é)
            const newTicketId = await testCreateTicket();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (newTicketId) {
                await testAcceptTicket(newTicketId);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞—è–≤–∫–∏
            if (newTicketId) {
                await testCompleteTicket(newTicketId);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // –¢–µ—Å—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF
            await testPDFExport();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // –¢–µ—Å—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞
            await testOfflineSupport();
            
            // –ò—Ç–æ–≥–∏
            const passed = testResults.filter(r => r.passed).length;
            const failed = testResults.filter(r => !r.passed).length;
            const total = testResults.length;
            const successRate = total > 0 ? Math.round((passed / total) * 100) : 0;
            
            const summaryDiv = document.getElementById('summary');
            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = `
                <h3>üìä –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <p><strong>–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:</strong> ${total}</p>
                <p><strong>‚úÖ –£—Å–ø–µ—à–Ω–æ:</strong> ${passed}</p>
                <p><strong>‚ùå –û—à–∏–±–æ–∫:</strong> ${failed}</p>
                <p><strong>üìà –£—Å–ø–µ—à–Ω–æ—Å—Ç—å:</strong> ${successRate}%</p>
            `;
            
            console.log('\n' + '='.repeat(50));
            console.log(`üìä –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:`);
            console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ: ${passed}`);
            console.log(`‚ùå –û—à–∏–±–æ–∫: ${failed}`);
            console.log(`üìà –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: ${successRate}%`);
            console.log('='.repeat(50));
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testResults = [];
        }
    </script>
</body>
</html>

