# Dockerfile –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ Render.com
# –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–±–∏—Ä–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–∑ —Å JDK –¥–ª—è —Å–±–æ—Ä–∫–∏ (–≤–µ—Ä—Å–∏—è Gradle –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –ø—Ä–æ–µ–∫—Ç–æ–º)
FROM gradle:8.13-jdk17-alpine AS build

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è —Å–±–æ—Ä–∫–∏
COPY gradle/ ./gradle/

# –°–æ–∑–¥–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π settings.gradle.kts —Ç–æ–ª—å–∫–æ –¥–ª—è server –º–æ–¥—É–ª—è (–±–µ–∑ Android)
RUN cat > settings.gradle.kts << 'EOF'
pluginManagement {
    repositories {
        mavenCentral()
        gradlePluginPortal()
    }
    plugins {
        kotlin("jvm") version "1.9.24"
        kotlin("plugin.serialization") version "1.9.24"
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
    repositories {
        mavenCentral()
        gradlePluginPortal()
    }
}
rootProject.name = "Techapp"
include(":server")
EOF

# –Ø–≤–Ω–æ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –∫–æ—Ä–Ω–µ–≤–æ–π build.gradle.kts, —á—Ç–æ–±—ã Gradle –Ω–µ –∏—Å–∫–∞–ª Android-–ø–ª–∞–≥–∏–Ω—ã
RUN cat > build.gradle.kts << 'EOF'
// –ü—É—Å—Ç–æ–π –∫–æ—Ä–Ω–µ–≤–æ–π build.gradle.kts –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Å–±–æ—Ä–∫–∏
// –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ server/build.gradle.kts
EOF

# –°–æ–∑–¥–∞–µ–º gradle.properties –±–µ–∑ Windows-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
RUN cat > gradle.properties << 'EOF'
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
org.gradle.daemon=false
org.gradle.parallel=false
org.gradle.caching=false
org.gradle.configureondemand=false
EOF

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ server –º–æ–¥—É–ª—å
COPY server/build.gradle.kts ./server/
COPY server/src/ ./server/src/

# –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–¥–ª—è PWA) –ø—Ä—è–º–æ –≤ –æ–±—Ä–∞–∑–µ
# –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ–∞–π–ª—ã –≤—Å–µ–≥–¥–∞ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã

# –°–æ–∑–¥–∞–µ–º config.js (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å APP_CONFIG)
RUN cat > config.js << 'EOF'
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è dev/prod –æ–∫—Ä—É–∂–µ–Ω–∏–π
(function() {
    'use strict';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const isProduction = window.location.protocol === 'https:' || 
                        window.location.hostname !== 'localhost' && 
                        window.location.hostname !== '127.0.0.1';
    
    // –ë–∞–∑–æ–≤—ã–π URL API
    const getApiBase = () => {
        if (isProduction) {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            return `${protocol}//${hostname}/api/v1`;
        } else {
            return 'http://localhost:8081/api/v1';
        }
    };
    
    // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è —Ñ–∞–π–ª–æ–≤ (—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏)
    const getFileBase = () => {
        if (isProduction) {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            return `${protocol}//${hostname}`;
        } else {
            return 'http://localhost:8081';
        }
    };
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    window.APP_CONFIG = {
        API_BASE: getApiBase(),
        FILE_BASE: getFileBase(),
        IS_PRODUCTION: isProduction,
        WS_URL: isProduction 
            ? `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.hostname}/ws`
            : 'ws://localhost:8081/ws'
    };
    
    console.log('üì± –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', {
        environment: isProduction ? 'PRODUCTION' : 'DEVELOPMENT',
        apiBase: window.APP_CONFIG.API_BASE,
        fileBase: window.APP_CONFIG.FILE_BASE
    });
})();
EOF

# –°–æ–∑–¥–∞–µ–º manifest.json
RUN cat > manifest.json << 'EOF'
{
  "name": "–ó–∞–≥–æ—Ä–æ–¥–Ω—ã–π –∫–ª—É–± '–î–∞—á–∞'",
  "short_name": "–î–∞—á–∞",
  "description": "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏ –≤ –∑–∞–≥–æ—Ä–æ–¥–Ω–æ–º –∫–ª—É–±–µ '–î–∞—á–∞'",
  "start_url": "/test-app.html",
  "display": "standalone",
  "background_color": "#2d5016",
  "theme_color": "#2d5016",
  "icons": [
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
EOF

# –°–æ–∑–¥–∞–µ–º sw.js (Service Worker) - –±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
RUN cat > sw.js << 'EOF'
const CACHE_NAME = 'techapp-cache-v1';
self.addEventListener('install', (event) => {
    event.waitUntil(caches.open(CACHE_NAME).then(() => self.skipWaiting()));
});
self.addEventListener('activate', (event) => {
    event.waitUntil(self.clients.claim());
});
self.addEventListener('fetch', (event) => {
    event.respondWith(fetch(event.request).catch(() => caches.match(event.request)));
});
EOF

# –ö–æ–ø–∏—Ä—É–µ–º test-app.html –∏ –∏–∫–æ–Ω–∫–∏
# –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
COPY test-app.html ./
# –ò–∫–æ–Ω–∫–∏ –∫–æ–ø–∏—Ä—É–µ–º (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
COPY icon-*.png ./

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Gradle –∏–∑ –æ–±—Ä–∞–∑–∞
# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
RUN echo "=== Project structure ===" && \
    ls -la && \
    echo "=== Server structure ===" && \
    ls -la server/ && \
    echo "=== Gradle version ===" && \
    gradle --version

# –°–æ–±–∏—Ä–∞–µ–º JAR —Ñ–∞–π–ª —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
RUN gradle :server:shadowJar --no-daemon --stacktrace --info || \
    (echo "=== Build failed, showing full log ===" && \
     gradle :server:shadowJar --no-daemon --stacktrace --debug 2>&1 | tail -100 && \
     exit 1)

# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ —Å JRE
FROM eclipse-temurin:17-jre-alpine

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π JAR –∏–∑ —Å—Ç–∞–¥–∏–∏ —Å–±–æ—Ä–∫–∏
COPY --from=build /app/server/build/libs/server-all.jar app.jar

# –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏–∑ —Å—Ç–∞–¥–∏–∏ —Å–±–æ—Ä–∫–∏
# –§–∞–π–ª—ã config.js, manifest.json –∏ sw.js —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤ —Å—Ç–∞–¥–∏–∏ build —á–µ—Ä–µ–∑ RUN cat
COPY --from=build /app/config.js ./
COPY --from=build /app/manifest.json ./
COPY --from=build /app/sw.js ./
# test-app.html –∏ –∏–∫–æ–Ω–∫–∏ –∫–æ–ø–∏—Ä—É–µ–º –∏–∑ —Å—Ç–∞–¥–∏–∏ build
COPY --from=build /app/test-app.html ./
# –ò–∫–æ–Ω–∫–∏ –∫–æ–ø–∏—Ä—É–µ–º –∏–∑ —Å—Ç–∞–¥–∏–∏ build (–µ—Å–ª–∏ –µ—Å—Ç—å)
COPY --from=build /app/icon-*.png ./

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite)
RUN mkdir -p /app/data
RUN mkdir -p /app/uploads

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 8081

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ Render)
ENV PORT=8081
ENV HOST=0.0.0.0

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
ENTRYPOINT ["java", "-jar", "app.jar"]

